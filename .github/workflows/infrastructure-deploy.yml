# ===========================================================================
# FastService Infrastructure - Provision Azure Resources
# ===========================================================================

name: Infrastructure Deployment

on:
  push:
    branches: [main]
    paths:
      - 'infra/**'
      - '.github/workflows/infrastructure-deploy.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - what-if
          - deploy

env:
  AZURE_RESOURCE_GROUP: fastservice-app

jobs:
  # ---------------------------------------------------------------------------
  # Validate Bicep Templates
  # ---------------------------------------------------------------------------
  validate:
    name: Validate Templates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Bicep
        run: az bicep build --file infra/main.bicep

  # ---------------------------------------------------------------------------
  # What-If Analysis
  # ---------------------------------------------------------------------------
  what-if:
    name: What-If Analysis
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.action == 'what-if'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: What-If Analysis
        run: |
          az deployment group what-if \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters \
              sqlConnectionString='${{ secrets.SQL_CONNECTION_STRING }}' \
              azureOpenAIApiKey='${{ secrets.AZURE_OPENAI_API_KEY }}' \
              dockerHubImage='${{ secrets.DOCKERHUB_USERNAME }}/fastservice-api' \
              repositoryUrl='${{ github.server_url }}/${{ github.repository }}'

  # ---------------------------------------------------------------------------
  # Deploy Infrastructure
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.action == 'deploy'

    outputs:
      backendUrl: ${{ steps.deployment.outputs.backendUrl }}
      frontendUrl: ${{ steps.deployment.outputs.frontendUrl }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep Template
        id: deployment
        run: |
          result=$(az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters \
              sqlConnectionString='${{ secrets.SQL_CONNECTION_STRING }}' \
              azureOpenAIApiKey='${{ secrets.AZURE_OPENAI_API_KEY }}' \
              dockerHubImage='${{ secrets.DOCKERHUB_USERNAME }}/fastservice-api' \
              repositoryUrl='${{ github.server_url }}/${{ github.repository }}' \
            --query 'properties.outputs' -o json)
          
          echo "backendUrl=$(echo $result | jq -r '.backendUrl.value')" >> $GITHUB_OUTPUT
          echo "frontendUrl=$(echo $result | jq -r '.frontendUrl.value')" >> $GITHUB_OUTPUT

      - name: Display Deployment Outputs
        run: |
          echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend URL | ${{ steps.deployment.outputs.backendUrl }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend URL | ${{ steps.deployment.outputs.frontendUrl }} |" >> $GITHUB_STEP_SUMMARY

      - name: Azure Logout
        run: az logout
        if: always()
